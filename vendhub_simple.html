<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VendHub Database</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --error-color: #ef4444;
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --card-bg: white;
            --border-color: #e2e8f0;
            --hover-bg: #f1f5f9;
        }

        body.dark-theme {
            --bg-color: #0f172a;
            --text-color: #e2e8f0;
            --card-bg: #1e293b;
            --border-color: #334155;
            --hover-bg: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg-color);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-color);
            transition: all 0.3s;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* –®–∞–ø–∫–∞ */
        .app-header {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px 30px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        .btn-secondary {
            background: var(--hover-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
        .theme-toggle {
            width: 60px;
            height: 30px;
            background: var(--border-color);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .theme-toggle.active {
            background: var(--primary-color);
        }

        .theme-toggle::after {
            content: '‚òÄÔ∏è';
            position: absolute;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .theme-toggle.active::after {
            content: 'üåô';
            transform: translateX(30px);
        }

        /* –ó–æ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .upload-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        .upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
        }

        .upload-area.dragover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border-color: var(--secondary-color);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-subtitle {
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 20px;
        }

        #fileInput {
            display: none;
        }

        /* –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ */
        .files-list {
            margin-top: 24px;
        }

        .files-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .files-list-title {
            font-size: 18px;
            font-weight: 600;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .file-card {
            background: var(--hover-bg);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .file-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .file-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .file-name {
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-delete {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: var(--error-color);
            color: white;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .file-card:hover .file-delete {
            opacity: 1;
        }

        .file-meta {
            display: flex;
            gap: 16px;
            font-size: 13px;
            opacity: 0.7;
        }

        /* –°–µ–∫—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö */
        .database-section {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            overflow: hidden;
        }

        .database-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .database-title {
            font-size: 20px;
            font-weight: 600;
        }

        .database-stats {
            font-size: 14px;
            opacity: 0.7;
        }

        /* –§–∏–ª—å—Ç—Ä—ã */
        .filters-section {
            padding: 20px 24px;
            background: var(--hover-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group.full-width {
            grid-column: 1 / -1;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            opacity: 0.7;
        }

        .filter-input,
        .filter-select {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filters-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            justify-content: flex-end;
        }

        /* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º */
        .period-groups {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .period-groups.expanded {
            max-height: 2000px;
        }

        .period-group {
            border-bottom: 1px solid var(--border-color);
        }

        .period-group-header {
            padding: 16px 24px;
            background: var(--hover-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .period-group-header:hover {
            background: var(--border-color);
        }

        .period-group-title {
            font-weight: 600;
            font-size: 16px;
        }

        .period-group-toggle {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s;
        }

        .period-group.expanded .period-group-toggle {
            transform: rotate(180deg);
        }

        .period-group-content {
            display: none;
        }

        .period-group.expanded .period-group-content {
            display: block;
        }

        /* –¢–∞–±–ª–∏—Ü–∞ */
        .table-scroll {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        thead {
            background: var(--hover-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            padding: 14px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: var(--primary-color);
            color: white;
        }

        th.sorted-asc::after {
            content: ' ‚ñ≤';
            font-size: 10px;
        }

        th.sorted-desc::after {
            content: ' ‚ñº';
            font-size: 10px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--hover-bg);
        }

        .text-center {
            text-align: center;
        }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            background: var(--hover-bg);
            flex-wrap: wrap;
            gap: 16px;
        }

        .pagination-info {
            font-size: 14px;
            opacity: 0.7;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--hover-bg);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .page-select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 13px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 100%;
            max-width: 95vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: var(--hover-bg);
            color: var(--text-color);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--error-color);
            color: white;
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.7;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-text {
            font-size: 14px;
        }

        /* Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 20px;
            border-radius: 10px;
            display: none;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            animation: slideInRight 0.3s;
            z-index: 3000;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            background: var(--success-color);
            color: white;
        }

        .toast.error {
            background: var(--error-color);
            color: white;
        }

        .toast.warning {
            background: #f59e0b;
            color: white;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            min-width: 300px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            margin: 0 auto 16px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .loading-progress {
            font-size: 14px;
            opacity: 0.7;
        }

        /* –°–∫—Ä–æ–ª–ª–±–∞—Ä */
        .table-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-scroll::-webkit-scrollbar-track {
            background: var(--hover-bg);
        }

        .table-scroll::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .hidden {
            display: none !important;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .app-header {
                flex-direction: column;
                gap: 16px;
            }

            .files-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="app-header">
            <div class="app-title">
                <div class="brand-logo">V</div>
                <span>VendHub Database</span>
            </div>
            <div class="app-controls">
                <button class="btn btn-danger btn-small hidden" id="clearAllBtn" onclick="clearAllData()">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
                </button>
                <div class="theme-toggle" onclick="toggleTheme()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"></div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-title">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã Excel</div>
                <div class="upload-subtitle">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É</div>
                <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    üìé –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                </button>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
            <div class="files-list hidden" id="filesList">
                <div class="files-list-header">
                    <h3 class="files-list-title">üìÇ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h3>
                    <span id="filesCount">0 —Ñ–∞–π–ª–æ–≤</span>
                </div>
                <div class="files-grid" id="filesGrid"></div>
            </div>
        </div>

        <!-- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <div class="database-section hidden" id="databaseSection">
            <div class="database-header">
                <div>
                    <h3 class="database-title">üóÉÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</h3>
                    <div class="database-stats">
                        –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id="totalRecords">0</span> |
                        –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö: <span id="uniqueRecords">0</span> |
                        –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="visibleRecords">0</span>
                    </div>
                </div>
                <button class="btn btn-success" onclick="exportDatabase()">
                    üì• –≠–∫—Å–ø–æ—Ä—Ç Excel
                </button>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filters-section">
                <div class="filters-grid">
                    <div class="filter-group full-width">
                        <label class="filter-label">üîç –ü–æ–∏—Å–∫</label>
                        <input type="text" class="filter-input" id="dbSearch"
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üìÖ –ü–µ—Ä–∏–æ–¥ (–º–µ—Å—è—Ü)</label>
                        <select class="filter-select" id="dbPeriodFilter">
                            <option value="">–í—Å–µ –ø–µ—Ä–∏–æ–¥—ã</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üìÜ –î–∞—Ç–∞ —Å</label>
                        <input type="date" class="filter-input" id="dbDateFrom">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">üìÜ –î–∞—Ç–∞ –ø–æ</label>
                        <input type="date" class="filter-input" id="dbDateTo">
                    </div>
                </div>
                <div class="filters-actions">
                    <button class="btn btn-secondary btn-small" onclick="togglePeriodGroups()">
                        üìä <span id="groupToggleText">–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ –º–µ—Å—è—Ü–∞–º</span>
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="resetFilters()">
                        üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>
            </div>

            <!-- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º -->
            <div class="period-groups" id="periodGroups"></div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ -->
            <div class="table-scroll">
                <table>
                    <thead id="dbTableHead"></thead>
                    <tbody id="dbTableBody"></tbody>
                </table>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            <div class="pagination">
                <div class="pagination-info">
                    –ü–æ–∫–∞–∑–∞–Ω–æ <span id="showFrom">0</span>-<span id="showTo">0</span> –∏–∑ <span id="showTotal">0</span>
                </div>
                <div class="pagination-controls">
                    <select class="page-select" id="pageSizeSelect" onchange="changePageSize()">
                        <option value="50">50 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                        <option value="100">100 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                        <option value="250">250 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                        <option value="500">500 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</option>
                    </select>
                    <button class="pagination-btn" onclick="goToPage(1)">¬´</button>
                    <button class="pagination-btn" onclick="prevPage()">‚Äπ</button>
                    <span id="pageNumbers"></span>
                    <button class="pagination-btn" onclick="nextPage()">‚Ä∫</button>
                    <button class="pagination-btn" onclick="goToPage(totalPages)">¬ª</button>
                </div>
            </div>
        </div>

        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-title">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
            <div class="empty-state-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã Excel –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∞–π–ª–∞ -->
    <div class="modal" id="fileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalFileName">–§–∞–π–ª</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="filters-section">
                    <div class="filter-group full-width">
                        <label class="filter-label">üîç –ü–æ–∏—Å–∫</label>
                        <input type="text" class="filter-input" id="modalSearch"
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ...">
                    </div>
                </div>
                <div class="table-scroll" style="flex: 1;">
                    <table>
                        <thead id="modalTableHead"></thead>
                        <tbody id="modalTableBody"></tbody>
                    </table>
                </div>
                <div class="pagination">
                    <div class="pagination-info">
                        –ü–æ–∫–∞–∑–∞–Ω–æ <span id="modalShowFrom">0</span>-<span id="modalShowTo">0</span> –∏–∑ <span id="modalShowTotal">0</span>
                    </div>
                    <div class="pagination-controls">
                        <select class="page-select" id="modalPageSize" onchange="changeModalPageSize()">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="250">250</option>
                        </select>
                        <button class="pagination-btn" onclick="modalGoToPage(1)">¬´</button>
                        <button class="pagination-btn" onclick="modalPrevPage()">‚Äπ</button>
                        <span id="modalPageNumbers"></span>
                        <button class="pagination-btn" onclick="modalNextPage()">‚Ä∫</button>
                        <button class="pagination-btn" onclick="modalGoToPage(modalTotalPages)">¬ª</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div class="loading-progress" id="loadingProgress">0%</div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastIcon">‚úî</span>
        <span id="toastMessage">–°–æ–æ–±—â–µ–Ω–∏–µ</span>
    </div>

    <script>
        // ========================================
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        // ========================================

        let appData = {
            files: [],
            database: [],
            headers: [],
            filteredData: [],
            periods: new Set(),
            pagination: {
                page: 1,
                pageSize: 50,
                totalPages: 1
            },
            sort: {
                column: null,
                direction: 'asc'
            }
        };

        let modalData = {
            fileIndex: null,
            headers: [],
            data: [],
            filteredData: [],
            pagination: {
                page: 1,
                pageSize: 50,
                totalPages: 1
            },
            sort: {
                column: null,
                direction: 'asc'
            }
        };

        let totalPages = 1;
        let modalTotalPages = 1;
        let periodGroupsExpanded = false;

        // ========================================
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // ========================================

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º—ã
            const darkTheme = localStorage.getItem('darkTheme') === 'true';
            if (darkTheme) {
                document.body.classList.add('dark-theme');
                document.querySelector('.theme-toggle').classList.add('active');
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            loadSavedData();

            // –°–æ–±—ã—Ç–∏—è
            setupEventHandlers();
        }

        function setupEventHandlers() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // –§–∏–ª—å—Ç—Ä—ã —Å debounce
            let searchTimeout;
            document.getElementById('dbSearch').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFilters, 300);
            });

            document.getElementById('dbPeriodFilter').addEventListener('change', applyFilters);
            document.getElementById('dbDateFrom').addEventListener('change', applyFilters);
            document.getElementById('dbDateTo').addEventListener('change', applyFilters);

            // –ü–æ–∏—Å–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
            document.getElementById('modalSearch').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyModalFilters, 300);
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        }

        // ========================================
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
        // ========================================

        function handleFileSelect(e) {
            handleFiles(e.target.files);
            e.target.value = '';
        }

        async function handleFiles(fileList) {
            const files = Array.from(fileList).filter(f => /\.(xlsx|xls)$/i.test(f.name));

            if (files.length === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã Excel (.xlsx, .xls)', 'error');
                return;
            }

            showLoading(true, '–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤...');

            let successCount = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateLoading(`–û–±—Ä–∞–±–æ—Ç–∫–∞: ${file.name}`, Math.round((i / files.length) * 100));

                try {
                    const data = await readExcelFile(file);

                    if (data.length < 2) {
                        showToast(`–§–∞–π–ª ${file.name} –ø—É—Å—Ç`, 'warning');
                        continue;
                    }

                    const fileInfo = {
                        name: file.name,
                        date: new Date().toISOString(),
                        headers: data[0],
                        data: data.slice(1),
                        rowCount: data.length - 1
                    };

                    const existingIndex = appData.files.findIndex(f => f.name === file.name);
                    if (existingIndex >= 0) {
                        appData.files[existingIndex] = fileInfo;
                    } else {
                        appData.files.push(fileInfo);
                    }

                    successCount++;
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ${file.name}:`, error);
                    showToast(`–û—à–∏–±–∫–∞: ${file.name}`, 'error');
                }
            }

            updateLoading('–û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...', 90);
            mergeDatabase();
            renderFilesList();
            renderDatabase();
            saveData();

            showLoading(false);
            showToast(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${successCount} –∏–∑ ${files.length}`, 'success');
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, {
                            header: 1,
                            defval: '',
                            blankrows: false
                        });
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };

                reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ========================================
        // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        // ========================================

        function mergeDatabase() {
            if (appData.files.length === 0) {
                appData.database = [];
                appData.headers = [];
                appData.periods.clear();
                return;
            }

            appData.headers = appData.files[0].headers;

            const allData = [];
            const uniqueKeys = new Set();

            appData.files.forEach(file => {
                file.data.forEach(row => {
                    const key = JSON.stringify(row);

                    if (!uniqueKeys.has(key)) {
                        uniqueKeys.add(key);

                        const rowObj = {
                            _raw: row,
                            _source: file.name
                        };

                        const dateInfo = extractDate(row);
                        if (dateInfo) {
                            rowObj._date = dateInfo.date;
                            rowObj._period = dateInfo.period;
                            appData.periods.add(dateInfo.period);
                        }

                        allData.push(rowObj);
                    }
                });
            });

            appData.database = allData;
            appData.filteredData = [...allData];

            updatePeriodFilter();
        }

        function extractDate(row) {
            for (let i = 0; i < row.length; i++) {
                const value = String(row[i]).trim();
                const date = parseDate(value);
                if (date) {
                    const period = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return { date, period };
                }
            }
            return null;
        }

        function parseDate(str) {
            if (!str || typeof str !== 'string') return null;

            const formats = [
                /(\d{4})-(\d{1,2})-(\d{1,2})/,
                /(\d{1,2})\.(\d{1,2})\.(\d{4})/,
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
            ];

            for (let i = 0; i < formats.length; i++) {
                const match = str.match(formats[i]);
                if (match) {
                    let year, month, day;

                    if (i === 0) {
                        year = parseInt(match[1]);
                        month = parseInt(match[2]) - 1;
                        day = parseInt(match[3]);
                    } else if (i === 1) {
                        day = parseInt(match[1]);
                        month = parseInt(match[2]) - 1;
                        year = parseInt(match[3]);
                    } else {
                        month = parseInt(match[1]) - 1;
                        day = parseInt(match[2]);
                        year = parseInt(match[3]);
                    }

                    if (year >= 2000 && year <= 2100 && month >= 0 && month <= 11 && day >= 1 && day <= 31) {
                        return new Date(year, month, day);
                    }
                }
            }

            return null;
        }

        function updatePeriodFilter() {
            const select = document.getElementById('dbPeriodFilter');
            const periods = Array.from(appData.periods).sort().reverse();

            select.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä–∏–æ–¥—ã</option>';

            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                               '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

            periods.forEach(period => {
                const [year, month] = period.split('-');
                const label = `${monthNames[parseInt(month) - 1]} ${year}`;
                const option = document.createElement('option');
                option.value = period;
                option.textContent = label;
                select.appendChild(option);
            });
        }

        // ========================================
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ UI
        // ========================================

        function renderFilesList() {
            const filesList = document.getElementById('filesList');
            const filesGrid = document.getElementById('filesGrid');
            const filesCount = document.getElementById('filesCount');
            const clearAllBtn = document.getElementById('clearAllBtn');

            if (appData.files.length === 0) {
                filesList.classList.add('hidden');
                clearAllBtn.classList.add('hidden');
                return;
            }

            filesList.classList.remove('hidden');
            clearAllBtn.classList.remove('hidden');
            filesCount.textContent = `${appData.files.length} —Ñ–∞–π–ª(–æ–≤)`;

            filesGrid.innerHTML = appData.files.map((file, index) => `
                <div class="file-card" onclick="openFileModal(${index})">
                    <div class="file-card-header">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</div>
                        <button class="file-delete" onclick="event.stopPropagation(); deleteFile(${index})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                    </div>
                    <div class="file-meta">
                        <span>üìä ${file.rowCount.toLocaleString()} –∑–∞–ø–∏—Å–µ–π</span>
                        <span>üìÖ ${new Date(file.date).toLocaleDateString('ru-RU')}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderDatabase() {
            const emptyState = document.getElementById('emptyState');
            const databaseSection = document.getElementById('databaseSection');

            if (appData.database.length === 0) {
                emptyState.classList.remove('hidden');
                databaseSection.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            databaseSection.classList.remove('hidden');

            document.getElementById('totalRecords').textContent =
                appData.files.reduce((sum, f) => sum + f.rowCount, 0).toLocaleString();
            document.getElementById('uniqueRecords').textContent =
                appData.database.length.toLocaleString();

            renderTableHeaders('dbTableHead', appData.headers, sortTable);

            applyFilters();
        }

        function renderTableHeaders(containerId, headers, sortCallback) {
            const thead = document.getElementById(containerId);
            const callbackName = sortCallback === sortTable ? 'sortTable' : 'sortModalTable';

            thead.innerHTML = `
                <tr>
                    <th onclick="${callbackName}(0)" class="text-center">#</th>
                    ${headers.map((h, i) => `
                        <th onclick="${callbackName}(${i + 1})" title="${escapeHtml(h)}">${escapeHtml(truncate(h, 20))}</th>
                    `).join('')}
                </tr>
            `;
        }

        function renderTableBody(containerId, data, startIndex = 0) {
            const tbody = document.getElementById(containerId);

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="100" style="text-align: center; padding: 40px;">
                            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map((row, index) => `
                <tr>
                    <td class="text-center">${startIndex + index + 1}</td>
                    ${row._raw.map(cell => `
                        <td title="${escapeHtml(String(cell))}">${escapeHtml(truncate(String(cell), 30))}</td>
                    `).join('')}
                </tr>
            `).join('');
        }

        // ========================================
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        // ========================================

        function applyFilters() {
            const search = document.getElementById('dbSearch').value.toLowerCase().trim();
            const period = document.getElementById('dbPeriodFilter').value;
            const dateFrom = document.getElementById('dbDateFrom').value;
            const dateTo = document.getElementById('dbDateTo').value;

            let filtered = appData.database;

            if (search) {
                filtered = filtered.filter(row =>
                    row._raw.some(cell => String(cell).toLowerCase().includes(search))
                );
            }

            if (period) {
                filtered = filtered.filter(row => row._period === period);
            }

            if (dateFrom) {
                const from = new Date(dateFrom);
                filtered = filtered.filter(row => row._date && row._date >= from);
            }

            if (dateTo) {
                const to = new Date(dateTo);
                filtered = filtered.filter(row => row._date && row._date <= to);
            }

            appData.filteredData = filtered;
            appData.pagination.page = 1;

            renderPaginatedData();
            renderPeriodGroups();
        }

        function resetFilters() {
            document.getElementById('dbSearch').value = '';
            document.getElementById('dbPeriodFilter').value = '';
            document.getElementById('dbDateFrom').value = '';
            document.getElementById('dbDateTo').value = '';

            applyFilters();
            showToast('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
        }

        function sortTable(columnIndex) {
            const sort = appData.sort;

            if (sort.column === columnIndex) {
                sort.direction = sort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sort.column = columnIndex;
                sort.direction = 'asc';
            }

            appData.filteredData.sort((a, b) => {
                if (columnIndex === 0) return 0;

                let aVal = a._raw[columnIndex - 1];
                let bVal = b._raw[columnIndex - 1];

                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return sort.direction === 'asc' ? aNum - bNum : bNum - aNum;
                }

                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();

                if (aVal < bVal) return sort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            document.querySelectorAll('#dbTableHead th').forEach((th, i) => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (i === columnIndex) {
                    th.classList.add(sort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });

            renderPaginatedData();
        }

        // ========================================
        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        // ========================================

        function renderPaginatedData() {
            const { page, pageSize } = appData.pagination;
            const data = appData.filteredData;

            totalPages = Math.ceil(data.length / pageSize) || 1;
            appData.pagination.totalPages = totalPages;

            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, data.length);
            const pageData = data.slice(start, end);

            renderTableBody('dbTableBody', pageData, start);

            document.getElementById('visibleRecords').textContent = data.length.toLocaleString();
            document.getElementById('showFrom').textContent = data.length > 0 ? start + 1 : 0;
            document.getElementById('showTo').textContent = end;
            document.getElementById('showTotal').textContent = data.length.toLocaleString();

            renderPageNumbers('pageNumbers', page, totalPages, 'goToPage');
        }

        function renderPageNumbers(containerId, currentPage, total, callbackName) {
            const container = document.getElementById(containerId);
            let html = '';

            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endPage = Math.min(total, startPage + maxButtons - 1);

            if (endPage - startPage + 1 < maxButtons) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}"
                                onclick="${callbackName}(${i})">${i}</button>`;
            }

            container.innerHTML = html;
        }

        function goToPage(page) {
            appData.pagination.page = Math.max(1, Math.min(page, totalPages));
            renderPaginatedData();
        }

        function prevPage() {
            goToPage(appData.pagination.page - 1);
        }

        function nextPage() {
            goToPage(appData.pagination.page + 1);
        }

        function changePageSize() {
            appData.pagination.pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            appData.pagination.page = 1;
            renderPaginatedData();
        }

        // ========================================
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º
        // ========================================

        function togglePeriodGroups() {
            periodGroupsExpanded = !periodGroupsExpanded;
            const container = document.getElementById('periodGroups');
            const text = document.getElementById('groupToggleText');

            if (periodGroupsExpanded) {
                container.classList.add('expanded');
                text.textContent = '–°–∫—Ä—ã—Ç—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ –º–µ—Å—è—Ü–∞–º';
            } else {
                container.classList.remove('expanded');
                text.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ –º–µ—Å—è—Ü–∞–º';
            }
        }

        function renderPeriodGroups() {
            const container = document.getElementById('periodGroups');

            const groups = {};
            appData.filteredData.forEach(row => {
                const period = row._period || '–ë–µ–∑ –¥–∞—Ç—ã';
                if (!groups[period]) {
                    groups[period] = [];
                }
                groups[period].push(row);
            });

            const sortedPeriods = Object.keys(groups).sort().reverse();

            if (sortedPeriods.length <= 1) {
                container.innerHTML = '';
                return;
            }

            const monthNames = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                               '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];

            container.innerHTML = sortedPeriods.map((period, index) => {
                let label = period;
                if (period !== '–ë–µ–∑ –¥–∞—Ç—ã') {
                    const [year, month] = period.split('-');
                    label = `${monthNames[parseInt(month) - 1]} ${year}`;
                }

                return `
                    <div class="period-group" id="period_${index}">
                        <div class="period-group-header" onclick="togglePeriodGroup(${index})">
                            <span class="period-group-title">${label}</span>
                            <span style="opacity: 0.7;">üìä ${groups[period].length.toLocaleString()} –∑–∞–ø–∏—Å–µ–π</span>
                            <button class="period-group-toggle">‚ñº</button>
                        </div>
                        <div class="period-group-content">
                            <div class="table-scroll" style="max-height: 400px;">
                                <table>
                                    <thead>${document.getElementById('dbTableHead').innerHTML}</thead>
                                    <tbody id="period_body_${index}"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
            sortedPeriods.forEach((period, index) => {
                const tbody = document.getElementById(`period_body_${index}`);
                if (tbody) {
                    tbody.innerHTML = groups[period].map((row, rowIndex) => `
                        <tr>
                            <td class="text-center">${rowIndex + 1}</td>
                            ${row._raw.map(cell => `
                                <td title="${escapeHtml(String(cell))}">${escapeHtml(truncate(String(cell), 30))}</td>
                            `).join('')}
                        </tr>
                    `).join('');
                }
            });
        }

        function togglePeriodGroup(index) {
            const group = document.getElementById(`period_${index}`);
            group.classList.toggle('expanded');
        }

        // ========================================
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        // ========================================

        function openFileModal(fileIndex) {
            const file = appData.files[fileIndex];
            if (!file) return;

            modalData.fileIndex = fileIndex;
            modalData.headers = file.headers;
            modalData.data = file.data.map(row => ({ _raw: row }));
            modalData.filteredData = [...modalData.data];
            modalData.pagination.page = 1;

            document.getElementById('modalFileName').textContent = file.name;
            document.getElementById('modalSearch').value = '';

            renderTableHeaders('modalTableHead', file.headers, sortModalTable);
            renderModalPaginatedData();

            document.getElementById('fileModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('fileModal').classList.remove('active');
        }

        function applyModalFilters() {
            const search = document.getElementById('modalSearch').value.toLowerCase().trim();

            if (search) {
                modalData.filteredData = modalData.data.filter(row =>
                    row._raw.some(cell => String(cell).toLowerCase().includes(search))
                );
            } else {
                modalData.filteredData = [...modalData.data];
            }

            modalData.pagination.page = 1;
            renderModalPaginatedData();
        }

        function sortModalTable(columnIndex) {
            const sort = modalData.sort;

            if (sort.column === columnIndex) {
                sort.direction = sort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sort.column = columnIndex;
                sort.direction = 'asc';
            }

            modalData.filteredData.sort((a, b) => {
                if (columnIndex === 0) return 0;

                let aVal = a._raw[columnIndex - 1];
                let bVal = b._raw[columnIndex - 1];

                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return sort.direction === 'asc' ? aNum - bNum : bNum - aNum;
                }

                aVal = String(aVal).toLowerCase();
                bVal = String(bVal).toLowerCase();

                if (aVal < bVal) return sort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return sort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            document.querySelectorAll('#modalTableHead th').forEach((th, i) => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (i === columnIndex) {
                    th.classList.add(sort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                }
            });

            renderModalPaginatedData();
        }

        function renderModalPaginatedData() {
            const { page, pageSize } = modalData.pagination;
            const data = modalData.filteredData;

            modalTotalPages = Math.ceil(data.length / pageSize) || 1;
            modalData.pagination.totalPages = modalTotalPages;

            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, data.length);
            const pageData = data.slice(start, end);

            renderTableBody('modalTableBody', pageData, start);

            document.getElementById('modalShowFrom').textContent = data.length > 0 ? start + 1 : 0;
            document.getElementById('modalShowTo').textContent = end;
            document.getElementById('modalShowTotal').textContent = data.length.toLocaleString();

            renderPageNumbers('modalPageNumbers', page, modalTotalPages, 'modalGoToPage');
        }

        function modalGoToPage(page) {
            modalData.pagination.page = Math.max(1, Math.min(page, modalTotalPages));
            renderModalPaginatedData();
        }

        function modalPrevPage() {
            modalGoToPage(modalData.pagination.page - 1);
        }

        function modalNextPage() {
            modalGoToPage(modalData.pagination.page + 1);
        }

        function changeModalPageSize() {
            modalData.pagination.pageSize = parseInt(document.getElementById('modalPageSize').value);
            modalData.pagination.page = 1;
            renderModalPaginatedData();
        }

        // ========================================
        // –≠–∫—Å–ø–æ—Ä—Ç
        // ========================================

        function exportDatabase() {
            if (appData.filteredData.length === 0) {
                showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
                return;
            }

            showLoading(true, '–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö...');

            try {
                const exportData = [
                    appData.headers,
                    ...appData.filteredData.map(row => row._raw)
                ];

                const ws = XLSX.utils.aoa_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö');

                const fileName = `VendHub_Database_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);

                showToast(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${appData.filteredData.length} –∑–∞–ø–∏—Å–µ–π`, 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========================================
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
        // ========================================

        function deleteFile(index) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${appData.files[index].name}"?`)) return;

            appData.files.splice(index, 1);
            mergeDatabase();
            renderFilesList();
            renderDatabase();
            saveData();

            showToast('–§–∞–π–ª —É–¥–∞–ª–µ–Ω', 'success');
        }

        function clearAllData() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ?')) return;

            appData.files = [];
            appData.database = [];
            appData.filteredData = [];
            appData.headers = [];
            appData.periods.clear();

            localStorage.removeItem('vendhubData');

            renderFilesList();
            renderDatabase();

            showToast('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã', 'success');
        }

        function saveData() {
            try {
                const dataToSave = {
                    files: appData.files,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('vendhubData', JSON.stringify(dataToSave));
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            }
        }

        function loadSavedData() {
            try {
                const saved = localStorage.getItem('vendhubData');
                if (saved) {
                    const data = JSON.parse(saved);
                    appData.files = data.files || [];

                    if (appData.files.length > 0) {
                        mergeDatabase();
                        renderFilesList();
                        renderDatabase();
                        showToast('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'success');
                    }
                }
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            }
        }

        // ========================================
        // –£—Ç–∏–ª–∏—Ç—ã
        // ========================================

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            document.querySelector('.theme-toggle').classList.toggle('active');
            localStorage.setItem('darkTheme', document.body.classList.contains('dark-theme'));
        }

        function showLoading(show, text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');

            if (show) {
                overlay.classList.add('active');
                loadingText.textContent = text;
            } else {
                overlay.classList.remove('active');
            }
        }

        function updateLoading(text, percent) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingProgress').textContent = `${percent}%`;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            toast.className = `toast ${type}`;
            icon.textContent = type === 'success' ? '‚úî' : type === 'error' ? '‚úï' : '‚ö†';
            msg.textContent = message;

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncate(str, length) {
            return str.length > length ? str.substring(0, length) + '...' : str;
        }
    </script>
</body>
</html>
